import { expect } from "chai";
import { ethers, artifacts, waffle, network } from "hardhat";
import dotenv from "dotenv";

dotenv.config();

// testing
const WETH_ADDRESS = "0x4200000000000000000000000000000000000006";
const ETH_ADDRESS = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";
const TEST_ADDRESS = "0x42f9134E9d3Bf7eEE1f8A5Ac2a4328B059E7468c"; // EOA
const TEST_VALUE = ethers.BigNumber.from("10000000000000000");

// synthetix
const VOLUME_REWARDS = ethers.constants.AddressZero;
const ADDRESS_RESOLVER = "0x95A6a3f44a70172E7d50a9e28c85Dfd712756B8C";
// synthetix: proxy
const SETH_PROXY = "0xE405de8F52ba7559f9df3C368500B6E6ae6Cee49";
const SUSD_PROXY = "0x8c6f28f2F1A3C87F0f938b96d27520d9751ec8d9";
const SLINK_PROXY = "0xc5Db22719A06418028A40A9B5E9A7c02959D0d08";
// synthetix: key
const SETH_BYTES32 = ethers.utils.formatBytes32String("sETH");
const SLINK_BYTES32 = ethers.utils.formatBytes32String("sLINK");
const SUSD_BYTES32 = ethers.utils.formatBytes32String("sUSD");

// 1inch
const AGGREGATION_ROUTER_V4 = "0x1111111254760F7ab3F16433eea9304126DCd199";
const AGGREGATION_EXECUTOR = "0x26271dfddbd250014f87f0f302c099d5a798bab1";

// https://dashboard.tenderly.co/tx/optimistic/0x0c9a18a7f145ab6b64098de909d18a2344dd8f409a19fd2d56936cc36fc50720
const ETH_TO_SUSD_ROUTE = "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000ca00000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000800000000000000000000000c858a329bf053be78d6239c4a4343b8fbd21472b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104128acb0800000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000420000000000000000000000000000000000000600000000000000000000000094b008aa00579c1307b0ef2c499ad98a8ce58e58000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000364ad0e7b1a0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000030000000000000000000000000094b008aa00579c1307b0ef2c499ad98a8ce58e5800000000000000000000000000000032000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001408000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000064eb5625d900000000000000000000000094b008aa00579c1307b0ef2c499ad98a8ce58e580000000000000000000000001337bedc9d22ecbe766df105c9623922a27963ec0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000008000000000000000000000001337bedc9d22ecbe766df105c9623922a27963ec0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000843df0212400000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000044800000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022414284aab00000000000000000000000000000000000000000000000000000000000000808000000000000000000000000000000000000000000000000000000000000044000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000000000003200000000000000000000000000000032800000000000000000000000e7ee03b72a89f87d161425e42548bd5492d06679000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104128acb0800000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d2500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d9000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000024432ce0a7c0000000000000000000000000000000000000000000000000000000000000080800000000000000000000000000000000000000000000000000000000000004400000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab100000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4059712240000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004470bdb9470000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d90000000000000000000000000000000000000000000000018d6e923bd8cb95880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000018414284aab000000000000000000000000000000000000000000000000000000000000008080000000000000000000000000000000000000000000000000000000000000440000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d900000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000064d1660f990000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d90000000000000000000000001111111254760f7ab3f16433eea9304126dcd19900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
const WETH_TO_SUSD_ROUTE = "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000008400000000000000000000000000000000000000000000000000000000000000b20800000000000000000000000dbd4ffc32b34f630dd8ac18d37162ec8462db7db0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001842b651a6c0000000000000000000000004200000000000000000000000000000000000006000000000000000000000000350a791bfc2c21f9ed5d10980dad2e2638ffa7f6000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000023594e869f298000000000000000000000000000000000000000000000000000000000006271899900000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab1000000000000000000000000000000000000000000000000000000000000001bb826ba042001e49163f2e37d961e409ff737a4ab339d79a1e99a3e98d628f994053f9d77f4cdf90fb611b25de2ce2027447108d6876c8ef201f721011eb87f730000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000002031494e434800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022414284aab00000000000000000000000000000000000000000000000000000000000000808000000000000000000000000000000000000000000000000000000000000044000000000000000000000000350a791bfc2c21f9ed5d10980dad2e2638ffa7f6000000000000000000000000000000320000000000000000000000000000003280000000000000000000000019ea026886cbb7a900ecb2458636d72b5cae223b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104128acb0800000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000350a791bfc2c21f9ed5d10980dad2e2638ffa7f600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022414284aab00000000000000000000000000000000000000000000000000000000000000808000000000000000000000000000000000000000000000000000000000000044000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000032000000000000000000000000000000328000000000000000000000002e80d5a7b3c613d854ee43243ff09808108561eb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104128acb0800000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000042000000000000000000000000000000000000060000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000024432ce0a7c0000000000000000000000000000000000000000000000000000000000000080800000000000000000000000000000000000000000000000000000000000004400000000000000000000000026271dfddbd250014f87f0f302c099d5a798bab100000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4059712240000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004470bdb9470000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d900000000000000000000000000000000000000000000000180f8c2286bac3e5e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000018414284aab000000000000000000000000000000000000000000000000000000000000008080000000000000000000000000000000000000000000000000000000000000440000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d900000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000064d1660f990000000000000000000000008c6f28f2f1a3c87f0f938b96d27520d9751ec8d90000000000000000000000001111111254760f7ab3f16433eea9304126dcd19900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
const SUSD_TO_WETH_ROUTE = "";

describe("Integration: Test Synthswap.sol", function () {
    before(async () => {
        await network.provider.request({
            method: "hardhat_reset",
            params: [
                {
                    forking: {
                        jsonRpcUrl: process.env.ARCHIVE_NODE_URL_L2,
                        // block number associated with tx: 0x0c9a18a7f145ab6b64098de909d18a2344dd8f409a19fd2d56936cc36fc50720
                        blockNumber: 6950543,
                    },
                },
            ],
        });

        await network.provider.request({
            method: "hardhat_impersonateAccount",
            params: [TEST_ADDRESS],
        });
    });

    it.skip("Test SynthSwap deployment", async () => {
        const SynthSwap = await ethers.getContractFactory("SynthSwap");
        const synthswap = await SynthSwap.deploy(
            SUSD_PROXY,
            AGGREGATION_ROUTER_V4,
            ADDRESS_RESOLVER,
            VOLUME_REWARDS
        );
        await synthswap.deployed();
        expect(synthswap.address).to.exist;
    });

    it.skip("Test swap ETH into sETH", async () => {
        // ETH -(1inchAggregator)-> sUSD -(Synthetix)-> sETH
        const SynthSwap = await ethers.getContractFactory("SynthSwap");
        const synthswap = await SynthSwap.deploy(
            SUSD_PROXY,
            AGGREGATION_ROUTER_V4,
            ADDRESS_RESOLVER,
            VOLUME_REWARDS
        );
        await synthswap.deployed();

        // pre-swap balance
        const IERC20ABI = (await artifacts.readArtifact("contracts/interfaces/IERC20.sol:IERC20")).abi;
        const sETH = new ethers.Contract(SETH_PROXY, IERC20ABI, waffle.provider);
        const preBalance = await sETH.balanceOf(TEST_ADDRESS);

        const abiCoder = ethers.utils.defaultAbiCoder;
        const caller = AGGREGATION_EXECUTOR;
        const swapDescription = {
            srcToken: ETH_ADDRESS,
            dstToken: SUSD_PROXY,
            srcReceiver: AGGREGATION_EXECUTOR,
            dstReceiver: synthswap.address,
            amount: TEST_VALUE,
            minReturnAmount: ethers.BigNumber.from("28087090916131374921"),
            flags: 0,
            permit: "0x"
        }
        
		const data = abiCoder.encode(
			[
				'address caller',
				'tuple(address srcToken, address dstToken, address srcReceiver, address dstReceiver, uint256 amount, uint256 minReturnAmount, uint256 flags, bytes permit) desc',
				'bytes data',
			],
			[caller, swapDescription, ETH_TO_SUSD_ROUTE]
		);

        // swap
        const signer = await ethers.getSigner(TEST_ADDRESS);
		synthswap.connect(signer).swapInto(
            SETH_BYTES32,
            SETH_PROXY,
            data, 
            {
				value: TEST_VALUE,
            }
        );
        
        const postBalance = await sETH.balanceOf(TEST_ADDRESS);
        expect(postBalance).to.be.above(preBalance);
    }).timeout(200000);

    it("Test swap WETH into sLINK", async () => {
        // WETH -(1inchAggregator)-> sUSD -(Synthetix)-> sLINK
        const SynthSwap = await ethers.getContractFactory("SynthSwap");
        const synthswap = await SynthSwap.deploy(
            SUSD_PROXY,
            AGGREGATION_ROUTER_V4,
            ADDRESS_RESOLVER,
            VOLUME_REWARDS
        );
        await synthswap.deployed();

        // pre-swap balance
        const IERC20ABI = (await artifacts.readArtifact("contracts/interfaces/IERC20.sol:IERC20")).abi;
        const sLINK = new ethers.Contract(SLINK_PROXY, IERC20ABI, waffle.provider);
        const preBalance = await sLINK.balanceOf(TEST_ADDRESS);

        const abiCoder = ethers.utils.defaultAbiCoder;
        const caller = AGGREGATION_EXECUTOR;
        const swapDescription = {
            srcToken: WETH_ADDRESS,
            dstToken: SUSD_PROXY,
            srcReceiver: AGGREGATION_EXECUTOR,
            dstReceiver: synthswap.address,
            amount: TEST_VALUE,
            minReturnAmount: ethers.BigNumber.from("27462734029813005758"),
            flags: 0,
            permit: "0x"
        }
        
		const data = abiCoder.encode(
			[
				'address caller',
				'tuple(address srcToken, address dstToken, address srcReceiver, address dstReceiver, uint256 amount, uint256 minReturnAmount, uint256 flags, bytes permit) desc',
				'bytes data',
			],
			[caller, swapDescription, WETH_TO_SUSD_ROUTE]
		);

        // must approve synthswap to swap tokens
        const signer = await ethers.getSigner(TEST_ADDRESS);
        const wETH = new ethers.Contract(WETH_ADDRESS, IERC20ABI, waffle.provider);
        await wETH.connect(signer).approve(synthswap.address, TEST_VALUE);

        // swap
		synthswap.connect(signer).swapInto(
            SLINK_BYTES32,
            SLINK_PROXY,
            data
        );
        
        const postBalance = await sLINK.balanceOf(TEST_ADDRESS);
        expect(postBalance).to.be.above(preBalance);
    }).timeout(200000);

    it.skip("Test swap sETH into WETH", async () => {
        // WETH -(1inchAggregator)-> sUSD -(Synthetix)-> sETH
        const SynthSwap = await ethers.getContractFactory("SynthSwap");
        const synthswap = await SynthSwap.deploy(
            SUSD_PROXY,
            AGGREGATION_ROUTER_V4,
            ADDRESS_RESOLVER,
            VOLUME_REWARDS
        );
        await synthswap.deployed();

        // pre-swap balance
        const IERC20ABI = (await artifacts.readArtifact("contracts/interfaces/IERC20.sol:IERC20")).abi;
        const WETH = new ethers.Contract(WETH_ADDRESS, IERC20ABI, waffle.provider);
        const preBalance = await WETH.balanceOf(TEST_ADDRESS);
        
        // approve SynthSwap to spend sETH
        const signer = await ethers.getSigner(TEST_ADDRESS);
        const sETH = new ethers.Contract(SETH_PROXY, IERC20ABI, waffle.provider);
        await sETH.connect(signer).approve(synthswap.address, TEST_VALUE);

        // confirm allowance
        const allowance = await sETH.allowance(signer.address, synthswap.address);
        expect(allowance).to.equal(TEST_VALUE);

        const abiCoder = ethers.utils.defaultAbiCoder;
        const caller = AGGREGATION_EXECUTOR;
        const swapDescription = {
            srcToken: SUSD_PROXY,
            dstToken: WETH_ADDRESS,
            srcReceiver: AGGREGATION_EXECUTOR,
            dstReceiver: TEST_ADDRESS,
            amount: 0, // TODO
            minReturnAmount: 0, // TODO
            flags: 0,
            permit: "0x"
        }
        
		const data = abiCoder.encode(
			[
				'address caller',
				'tuple(address srcToken, address dstToken, address srcReceiver, address dstReceiver, uint256 amount, uint256 minReturnAmount, uint256 flags, bytes permit) desc',
				'bytes data',
			],
			[caller, swapDescription, SUSD_TO_WETH_ROUTE]
		);

        // swap
		await synthswap.connect(signer).swapOutOf(
            SETH_BYTES32,
            SETH_PROXY,
            TEST_VALUE,
            data,
            {
				gasLimit: 1000000,
            }
        );
        
        // post-swap balance
        const postBalance = await WETH.balanceOf(TEST_ADDRESS);
        expect(postBalance).to.be.above(preBalance);
    }).timeout(200000);
});